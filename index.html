<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GridScaper</title>
  <style>
  :root {
  --primary-bg: rgba(0,0,0,0.75);
  --panel-bg: #181c1f;
  --panel-border: #22292f;
  --accent: #73c2fb;
  --danger: #ff6b6b;
  --text: #fff;
  --input-bg: rgba(115,194,251,0.2);
  --input-border: rgba(115,194,251,0.4);
  --button-hover: rgba(115,194,251,0.3);
  --button-active: rgba(115,194,251,0.4);
  --section-title: #73c2fb;
}
body.dark-mode {
  --primary-bg: #0a1014;
  --panel-bg: #10151a;
  --panel-border: #00ffe7;
  --accent: #00ffe7;
  --danger: #ff2d55;
  --text: #00ffe7;
  --input-bg: #1a232a;
  --input-border: #00ffe7;
  --button-hover: #003b3b;
  --button-active: #005050;
  --section-title: #00ffe7;
}
    html,
    body,
    #c {
      margin: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }

    #hud {
      position: fixed;
      top: 8px;
      left: 8px;
      background: var(--primary-bg);
      color: var(--text);
      padding: 12px 16px;
      font-size: 12px;
      line-height: 1.4;
      border: 1.5px solid var(--panel-border);
      border-radius: 8px;
      user-select: none;
      max-width: 420px;
      z-index: 1000;
    }

    .control-section {
      margin-bottom: 14px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .control-section:last-of-type {
      border-bottom: none;
      margin-bottom: 0;
    }

    .section-title {
      font-weight: bold;
      font-size: 13px;
      margin-bottom: 6px;
      color: var(--section-title);
    }

    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
    }

    .control-group input[type="range"] {
      margin-top: 2px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
    }

    .instructions {
      font-size: 11px;
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .hud-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      margin-bottom: 8px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    .hud-title {
      font-weight: bold;
      font-size: 13px;
      color: var(--accent);
      letter-spacing: 2px;
    }

    .hud-collapse-btn {
      font-size: 16px;
      font-weight: bold;
      color: var(--accent);
      width: 20px;
      text-align: center;
      user-select: none;
    }

    .hud-header:hover {
      opacity: 0.8;
    }

    .hud-content {
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .hud-content.collapsed {
      height: 0;
      opacity: 0;
      margin: 0;
      padding: 0;
    }

    .slider-with-value {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
    }

    .slider-with-value input[type="range"] {
      flex: 1;
      min-width: 80px;
    }

    .slider-with-value span {
      font-size: 11px;
      color: var(--accent);
      font-weight: bold;
      min-width: 35px;
      text-align: right;
    }

    #hud input[type="range"],
    #hud select,
    #hud button {
      vertical-align: middle;
      cursor: pointer;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      color: var(--text);
      font-family: 'Consolas', 'Menlo', 'Monaco', monospace;
      letter-spacing: 0.5px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin: 1px;
      transition: all 0.2s ease;
    }

    #hud button:hover {
      background: var(--button-hover);
      border-color: var(--accent);
      color: var(--accent);
    }

    #hud button:active {
      background: var(--button-active);
      border-color: var(--accent);
      color: var(--danger);
    }

    /* Improved dropdown styling for better readability */
    #hud select {
      background: rgba(40, 40, 40, 0.95);
      border: 1px solid rgba(115, 194, 251, 0.6);
      color: #ffffff;
      font-weight: 500;
    }

    #hud select:hover {
      background: rgba(50, 50, 50, 0.98);
      border-color: rgba(115, 194, 251, 0.8);
    }

    #hud select:focus {
      background: rgba(60, 60, 60, 1);
      border-color: #73c2fb;
      outline: none;
      box-shadow: 0 0 0 2px rgba(115, 194, 251, 0.3);
    }

    /* Style dropdown options for better contrast */
    #hud select option {
      background: rgba(40, 40, 40, 1);
      color: #ffffff;
      padding: 4px;
    }

    /* Drag and drop overlay */
    #dragDropOverlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      color: white;
      font-size: 24px;
      font-weight: bold;
      pointer-events: none;
    }

    #dragDropOverlay.active {
      display: flex;
    }

    .drag-drop-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }

    .drag-drop-text {
      text-align: center;
      line-height: 1.4;
    }

    /* Loading overlay */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      color: white;
      font-family: Arial, sans-serif;
    }

    #loadingOverlay.active {
      display: flex;
    }

    .loading-content {
      text-align: center;
      background: rgba(40, 40, 40, 0.95);
      padding: 30px 40px;
      border-radius: 10px;
      border: 2px solid #555;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #333;
      border-top: 4px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      margin-top: 10px;
    }

    #hud label {
      margin-right: 4px;
    }

    #jsonPanel {
      position: absolute;
      top: 0;
      right: 0;
      width: 310px;
      margin: 8px;
      background-color: #1a1a1a;
      color: #efefef;
      font-family: 'Lucida Grande', sans-serif;
      font-size: 11px;
      border-radius: 6px;
      overflow: hidden;
      z-index: 1000;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    }

    .panel-title {
      padding: 8px;
      background: #323232;
      color: #efefef;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #2c2c2c;
    }

    .panel-title:hover {
      background: #3a3a3a;
    }

    .panel-content {
      max-height: calc(100vh - 120px);
      overflow: auto;
    }

    .panel-folder {
      margin-bottom: 4px;
      border-bottom: 1px solid #2c2c2c;
    }

    .panel-folder-title {
      padding: 8px;
      cursor: pointer;
      background-color: #262626;
      display: flex;
      justify-content: space-between;
    }

    .panel-folder-title:hover {
      background-color: #2f2f2f;
    }

    .panel-folder-content {
      padding: 8px;
      overflow: hidden;
      transition: height 0.3s ease;
      background-color: #1a1a1a;
    }

    .folder-collapsed .panel-folder-content {
      height: 0 !important;
      padding: 0;
    }

    .json-key { color: #9cdcfe; }
    .json-string { color: #ce9178; }
    .json-number { color: #b5cea8; }
    .json-boolean { color: #569cd6; }
    .json-null { color: #777; }

    .json-row {
      padding: 4px 8px;
      display: flex;
      justify-content: space-between;
    }

    .json-row:nth-child(odd) {
      background-color: #222;
    }

    .json-value {
      text-align: right;
    }

    #scenariosPanel {
      position: fixed;
      top: 8px;
      right: 8px;
      background: var(--primary-bg, rgba(0, 0, 0, 0.55));
      color: var(--text, #fff);
      padding: 6px 10px;
      font-size: 12px;
      line-height: 1.4;
      border-radius: 6px;
      user-select: none;
      font-family: sans-serif;
      max-width: 300px;
      border: 1.5px solid var(--panel-border, #22292f);
    }

    .scenarios-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-weight: bold;
      cursor: pointer;
      padding: 2px 0;
      color: var(--accent, #73c2fb);
      border-bottom: 1px solid var(--panel-border, #22292f);
    }

    .scenarios-header:hover {
      opacity: 0.8;
    }

    .scenarios-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
      transition: all 0.3s ease;
    }

    .scenarios-grid.collapsed {
      height: 0;
      overflow: hidden;
      opacity: 0;
      margin-bottom: 0;
    }

    .scenario-button {
      background: var(--panel-bg, rgba(255, 255, 255, 0.1));
      border: 1px solid var(--panel-border, #22292f);
      border-radius: 4px;
      padding: 6px 8px;
      cursor: pointer;
      font-size: 11px;
      color: var(--text, #fff);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
      text-align: left;
    }

    .scenario-button:hover {
      background: var(--button-hover, rgba(255, 255, 255, 0.2));
      border-color: var(--accent, #73c2fb);
      color: var(--accent, #73c2fb);
      transform: translateY(-1px);
    }

    .scenario-button:active {
      background: var(--button-active, #005050);
      border-color: var(--accent, #00ffe7);
      color: var(--danger, #ff6b6b);
      transform: translateY(0);
    }

    .scenario-emoji {
      font-size: 14px;
      display: inline-block;
      min-width: 16px;
      color: var(--accent, #73c2fb);
    }

    .scenario-text {
      font-size: 10px;
      line-height: 1.2;
      color: var(--text, #fff);
    }
    
    /* Challenge Mode Panel */
    #challengePanel {
      position: fixed;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary-bg);
      color: var(--text);
      padding: 12px 20px;
      font-size: 12px;
      border: 1.5px solid var(--panel-border);
      border-radius: 8px;
      user-select: none;
      z-index: 1000;
      display: none;
      min-width: 600px;
      max-width: 800px;
    }
    
    #challengePanel.active {
      display: block;
    }
    
    .challenge-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--panel-border);
    }
    
    .challenge-title {
      font-weight: bold;
      font-size: 14px;
      color: var(--accent);
      letter-spacing: 1px;
    }
    
    .challenge-content {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .challenge-objective {
      flex: 1;
      min-width: 200px;
    }
    
    .challenge-objective-title {
      font-size: 11px;
      opacity: 0.8;
      margin-bottom: 4px;
    }
    
    .challenge-objective-text {
      font-size: 13px;
      font-weight: bold;
      color: var(--accent);
    }
    
    .challenge-stats {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .challenge-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .challenge-stat-label {
      font-size: 10px;
      opacity: 0.7;
    }
    
    .challenge-stat-value {
      font-size: 14px;
      font-weight: bold;
    }
    
    .challenge-stat-value.over-budget {
      color: var(--danger);
    }
    
    .challenge-stat-value.under-budget {
      color: #4ade80;
    }
    
    .challenge-success {
      flex: 1 1 100%;
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      border-radius: 6px;
      padding: 10px;
      margin-top: 8px;
    }
    
    .challenge-success-title {
      font-size: 13px;
      font-weight: bold;
      color: #4ade80;
      margin-bottom: 8px;
      text-align: center;
    }
    
    .challenge-success-stats {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .success-stat {
      display: flex;
      gap: 5px;
      font-size: 11px;
    }
    
    .success-label {
      opacity: 0.8;
    }
    
    .success-value {
      font-weight: bold;
      color: #4ade80;
    }
    
    .challenge-actions {
      display: flex;
      gap: 8px;
    }
    
    .challenge-marker {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 4px;
      vertical-align: middle;
    }
    
    .challenge-marker.start {
      background: #22c55e;
      box-shadow: 0 0 10px #22c55e;
    }
    
    .challenge-marker.goal {
      background: #3b82f6;
      box-shadow: 0 0 10px #3b82f6;
    }
    
    /* Tool Panel */
    #toolPanel {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary-bg);
      border: 2px solid var(--panel-border);
      border-radius: 12px;
      padding: 12px 20px;
      display: flex;
      gap: 12px;
      align-items: center;
      z-index: 900;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      transition: bottom 0.3s ease;
    }
    
    /* Move tool panel up when challenge mode is active */
    #challengePanel.active ~ #toolPanel {
      bottom: 200px;
    }
    
    .tool-button {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 12px 16px;
      background: var(--input-bg);
      border: 2px solid var(--input-border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 80px;
      color: var(--text);
      font-family: sans-serif;
    }
    
    .tool-button:hover {
      background: var(--button-hover);
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .tool-button.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #000;
      font-weight: bold;
    }
    
    .tool-icon {
      font-size: 24px;
      line-height: 1;
    }
    
    .tool-name {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .tool-separator {
      width: 2px;
      height: 50px;
      background: var(--panel-border);
      margin: 0 4px;
    }
    
    /* Inspection Panel */
    #inspectionPanel {
      position: fixed;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      background: var(--panel-bg);
      border: 2px solid var(--panel-border);
      border-radius: 12px;
      padding: 0;
      width: 280px;
      z-index: 1100;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
      display: none;
    }
    
    #inspectionPanel.active {
      display: block;
    }
    
    .inspection-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      background: var(--input-bg);
      border-bottom: 2px solid var(--panel-border);
      border-radius: 10px 10px 0 0;
    }
    
    .inspection-title {
      font-weight: bold;
      font-size: 13px;
      color: var(--accent);
      letter-spacing: 2px;
    }
    
    .close-inspection-btn {
      background: none;
      border: none;
      color: var(--text);
      font-size: 28px;
      line-height: 1;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .close-inspection-btn:hover {
      background: var(--button-hover);
      color: var(--danger);
    }
    
    .inspection-content {
      padding: 16px;
    }
    
    .inspection-diagram {
      margin-bottom: 16px;
      border-radius: 6px;
      overflow: hidden;
      background: #000;
      padding: 0;
    }
    
    #inspectionCanvas {
      display: block;
      width: 220px;
      height: 440px;
      border: 1px solid #00ffe733;
      border-radius: 4px;
      background: #0a0a0a;
      margin: 0 auto;
    }
    
    .inspection-data {
      font-size: 12px;
      color: var(--text);
    }
    
    .inspection-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .inspection-row:last-child {
      border-bottom: none;
    }
    
    .data-label {
      font-weight: 600;
      color: var(--accent);
    }
    
    .data-value {
      font-family: 'Consolas', 'Menlo', 'Monaco', monospace;
      color: var(--text);
    }
    
    .inspection-section-title {
      font-weight: bold;
      font-size: 11px;
      color: var(--section-title);
      margin-top: 12px;
      margin-bottom: 6px;
      padding-bottom: 4px;
      border-bottom: 1px solid var(--panel-border);
      letter-spacing: 1px;
    }
    
    /* Toast Notifications */
    #toastContainer {
      position: fixed;
      bottom: 250px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }
    
    /* Move toast container when not in challenge mode */
    body:not(:has(#challengePanel.active)) #toastContainer {
      bottom: 150px;
    }
    
    .toast {
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 13px;
      font-family: sans-serif;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      animation: toastSlideIn 0.3s ease;
      max-width: 400px;
      text-align: center;
    }
    
    .toast.warning {
      background: rgba(251, 191, 36, 0.9);
      color: #000;
      border-color: rgba(251, 191, 36, 0.3);
    }
    
    .toast.error {
      background: rgba(239, 68, 68, 0.9);
      color: #fff;
      border-color: rgba(239, 68, 68, 0.3);
    }
    
    .toast.fade-out {
      animation: toastFadeOut 0.3s ease forwards;
    }
    
    @keyframes toastSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes toastFadeOut {
      to {
        opacity: 0;
        transform: translateY(-10px);
      }
    }
  </style>
  <script src="https://unpkg.com/three@0.139.2/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.139.2/examples/js/controls/OrbitControls.js"></script>
  <script type="module" src="js/config.js"></script>
  <script type="module" src="js/terrain.js"></script>
  <script type="module" src="js/ui.js"></script>
  <script type="module" src="js/gisImportDialog.js"></script>
  <script type="module" src="js/main.js"></script>
  <script type="module" src="json-view.js"></script>
</head>
<body>
  <div id="hud">
  <div class="hud-header" id="hudToggle">
    <span class="hud-title">üéõÔ∏è GridScaper Controls</span>
    <span style="flex:1"></span>
    <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;user-select:none;">
      <input type="checkbox" id="darkModeToggle" style="accent-color:#00ffe7;vertical-align:middle;" />
      <span style="color:#00ffe7;font-weight:bold;">Dark Mode</span>
      <script>
        // Prevent dark mode toggle from collapsing the panel
        const darkLabel = document.querySelector('label[for="darkModeToggle"], label > #darkModeToggle')?.parentElement;
        const darkInput = document.getElementById('darkModeToggle');
        if (darkLabel) {
          darkLabel.addEventListener('click', e => e.stopPropagation());
        }
        if (darkInput) {
          darkInput.addEventListener('click', e => e.stopPropagation());
        }
      </script>
    </label>
    <span class="hud-collapse-btn" id="hudCollapseBtn">‚àí</span>
  </div>
    
    <div class="hud-content" id="hudContent">
      <div class="instructions"><strong>P</strong>: Pole tool | <strong>C</strong>: Conductor tool | <strong>I</strong>: Inspect tool | <strong>E</strong>: Eraser tool | <strong>Alt-drag</strong>: resize pole height | <strong>Ctrl+Z</strong>: Undo | <strong>Ctrl+Y</strong>: Redo | <strong>Delete</strong>: Remove pole | <strong>Esc</strong>: Cancel tool</div>
      
      <!-- History Section -->
      <div class="control-section">
        <div class="section-title">‚Ü©Ô∏è History</div>
        <div class="control-row">
          <button id="undoButton" title="Undo (Ctrl+Z)" style="opacity: 0.5;">‚Ü∂ Undo</button>
          <button id="redoButton" title="Redo (Ctrl+Y)" style="opacity: 0.5;">‚Ü∑ Redo</button>
        </div>
      </div>
      
      <!-- Pole Configuration Section -->
      <div class="control-section">
        <div class="section-title">üèóÔ∏è Pole Configuration</div>
        <div class="control-row">
          <label class="control-group">
            New pole height:
            <div class="slider-with-value">
              <input id="heightSlider" type="range" min="1" max="40" step="1" value="20" />
              <span id="heightLabel">20</span> ft
            </div>
          </label>
          <label class="control-group">
            Tension:
            <div class="slider-with-value">
              <input id="tensionSlider" type="range" min="500" max="5000" step="100" value="2000" />
              <span id="tensionLabel">2000 lbs</span>
            </div>
          </label>
        </div>
      </div>

      <!-- Display Options Section -->
      <div class="control-section">
        <div class="section-title">üëÅÔ∏è Display Options</div>
        <div class="control-row">
          <label class="checkbox-group">
            <input type="checkbox" id="showGridCheck" checked /> Grid
          </label>
          <label class="checkbox-group">
            <input type="checkbox" id="showGridLabelsCheck" /> Grid Labels
          </label>
          <label class="checkbox-group">
            <input type="checkbox" id="showPoleHeightLabels" /> Pole Heights
          </label>
          <label class="checkbox-group">
            <input type="checkbox" id="showSagCalculations" /> Sag Calculations
          </label>
          <label class="checkbox-group">
            <input type="checkbox" id="showClearanceBuffers" /> Clearance Buffers
          </label>
        </div>
      </div>

      <!-- Safety & Analysis Section -->
      <div class="control-section">
        <div class="section-title">‚ö†Ô∏è Safety & Analysis</div>
        <div class="control-row">
          <label class="control-group">
            Clearance threshold:
            <div class="slider-with-value">
              <input id="clearanceThreshold" type="range" min="5" max="50" step="1" value="15" />
              <span id="clearanceLabel">15</span> ft
            </div>
          </label>
        </div>
        <div id="clearanceWarning" style="display: none; color: #ff6b6b; font-weight: bold; margin-top: 6px;">
          ‚ö†Ô∏è CLEARANCE ISSUE: Lines too close to ground surface
        </div>
      </div>

      <!-- Actions Section -->
      <div class="control-section">
        <div class="section-title">üéÆ Actions</div>
        <div class="control-row">
          <button id="downloadJSON">üì• Download</button>
          <button id="importJSON">üì§ Import Scene</button>
          <button id="importGIS">üó∫Ô∏è Import GIS</button>
          <button id="importElevation">üìà Elevation Profile</button>
          <button id="copyLink">üîó Copy Link</button>
          <button id="clearScene">üóëÔ∏è Clear Scene</button>
          <!-- Removed random terrain button -->
        </div>
      </div>
      
      <!-- Mode Toggle Section -->
      <div class="control-section">
        <div class="section-title">üéØ Mode</div>
        <div class="control-row">
          <button id="toggleChallengeMode">üèÜ Challenge Mode</button>
          <button id="sandboxModeButton" style="display:none;">üõ†Ô∏è Sandbox Mode</button>
        </div>
      </div>
    </div>

    <div id="copyLinkToast" style="display: none; position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 4px; z-index: 10000;">
      üîó Link copied to clipboard!
    </div>
  </div>
  
  <div id="scenariosPanel">
    <div class="scenarios-header">
      <span>üìã Scenarios</span>
      <span id="scenariosToggle" style="margin-left: auto; font-weight: normal;">‚àí</span>
    </div>
    <div class="scenarios-grid" id="scenariosContent">
      <div class="scenario-button" data-url="index.html">
        <span class="scenario-emoji">üèóÔ∏è</span>
        <span class="scenario-text">Open<br>Playground</span>
      </div>
      <div class="scenario-button" data-url="?elevation=0,5,2,3,6,5,0,2,0&clearanceThreshold=15">
        <span class="scenario-emoji">üè†</span>
        <span class="scenario-text">Basic</span>
      </div>
      <div class="scenario-button" data-url="?elevation=15,10,5,0,-5,-10,-15,-20,-15,-10,-5,0,5,10,15,20,15&clearanceThreshold=20">
        <span class="scenario-emoji">üèîÔ∏è</span>
        <span class="scenario-text">Valley<br>Crossing</span>
      </div>
      <div class="scenario-button" data-url="?elevation=0,10,0,20,10,5,0,5,10,20,30,20,10,5,0&clearanceThreshold=18">
        <span class="scenario-emoji">üåä</span>
        <span class="scenario-text">Rolling<br>Hills</span>
      </div>
    </div>
  </div>
  
  <!-- Drag and Drop Overlay -->
  <div id="dragDropOverlay">
    <div class="drag-drop-icon">üìÅ</div>
    <div class="drag-drop-text">
      Drop GridScaper scene file here<br>
      <small>(.json files only)</small>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading scene...</div>
    </div>
  </div>
  
  <!-- Challenge Mode Panel -->
  <div id="challengePanel">
    <div class="challenge-header">
      <div class="challenge-title">üèÜ CHALLENGE MODE</div>
      <button id="exitChallengeMode" style="padding: 4px 8px; font-size: 11px;">Exit Challenge</button>
    </div>
    <div class="challenge-content">
      <div class="challenge-objective">
        <div class="challenge-objective-title">OBJECTIVE</div>
        <div class="challenge-objective-text">
          <span class="challenge-marker start"></span> Connect Substation to Customer 
          <span class="challenge-marker goal"></span>
        </div>
      </div>
      <div class="challenge-stats">
        <div class="challenge-stat">
          <div class="challenge-stat-label">Budget:</div>
          <div class="challenge-stat-value" id="challengeBudget">$5,500</div>
        </div>
        <div class="challenge-stat">
          <div class="challenge-stat-label">Spent</div>
          <div class="challenge-stat-value" id="challengeSpent">$0</div>
        </div>
        <div class="challenge-stat">
          <div class="challenge-stat-label">Remaining</div>
          <div class="challenge-stat-value under-budget" id="challengeRemaining">$50,000</div>
        </div>
        <div class="challenge-stat">
          <div class="challenge-stat-label">Poles</div>
          <div class="challenge-stat-value" id="challengePoles">0</div>
        </div>
      </div>
      <div class="challenge-success" id="challengeSuccess" style="display: none;">
        <div class="challenge-success-title">üéâ SUCCESS!</div>
        <div class="challenge-success-stats">
          <div class="success-stat">
            <span class="success-label">Savings:</span>
            <span class="success-value" id="successSavings">$0</span>
          </div>
          <div class="success-stat">
            <span class="success-label">Poles Used:</span>
            <span class="success-value" id="successPoles">0</span>
          </div>
          <div class="success-stat">
            <span class="success-label">Avg Span:</span>
            <span class="success-value" id="successAvgSpan">0 ft</span>
          </div>
          <div class="success-stat">
            <span class="success-label">Efficiency:</span>
            <span class="success-value" id="successEfficiency">0%</span>
          </div>
        </div>
      </div>
      <div class="challenge-actions">
        <button id="checkSolution">‚úì Check Solution</button>
        <button id="resetChallenge">‚Üª Reset</button>
      </div>
    </div>
  </div>
  
  <!-- Tool Panel -->
  <div id="toolPanel">
    <div class="tool-button active" id="poleTool" data-tool="pole" title="Place poles (P)">
      <div class="tool-icon">üèóÔ∏è</div>
      <div class="tool-name">Pole</div>
    </div>
    <div class="tool-button active" id="conductorTool" data-tool="conductor" title="Draw conductors (C)">
      <div class="tool-icon">‚ö°</div>
      <div class="tool-name">Conductor</div>
    </div>
    <div class="tool-separator"></div>
    <div class="tool-button" id="inspectTool" data-tool="inspect" title="Inspect pole (I)">
      <div class="tool-icon">üîç</div>
      <div class="tool-name">Inspect</div>
    </div>
    <div class="tool-button" id="eraserTool" data-tool="eraser" title="Erase (E)">
      <div class="tool-icon">üóëÔ∏è</div>
      <div class="tool-name">Eraser</div>
    </div>
  </div>
  
  <!-- Inspection Panel -->
  <div id="inspectionPanel">
    <div class="inspection-header">
      <span class="inspection-title">POLE INSPECTION</span>
      <button id="closeInspection" class="close-inspection-btn">√ó</button>
    </div>
    <div class="inspection-content">
      <h3 id="inspectionPoleTitle" style="margin: 0 0 10px 0; color: #00ffe7; font-size: 16px; text-align: center;">Pole #-</h3>
      <div class="inspection-diagram">
        <div style="text-align: center; margin-bottom: 8px;">
          <span style="color: #888; font-size: 11px; font-weight: bold; font-family: Consolas, monospace; letter-spacing: 1px;">TOP VIEW</span>
        </div>
        <canvas id="inspectionCanvas" width="220" height="440"></canvas>
        <div style="text-align: center; margin-top: 8px;">
          <span style="color: #888; font-size: 11px; font-weight: bold; font-family: Consolas, monospace; letter-spacing: 1px;">SIDE VIEW</span>
        </div>
      </div>
      <div class="inspection-data">
        <div class="inspection-row">
          <span class="data-label">Position:</span>
          <span class="data-value" id="inspectPosition">-</span>
        </div>
        <div class="inspection-row">
          <span class="data-label">Height:</span>
          <span class="data-value" id="inspectHeight">-</span>
        </div>
        <div class="inspection-row">
          <span class="data-label">Base Elevation:</span>
          <span class="data-value" id="inspectBase">-</span>
        </div>
      </div>
    </div>
  </div>
  
  <canvas id="c"></canvas>
  <script>
  const darkToggle = document.getElementById('darkModeToggle');
  const body = document.body;
  if (localStorage.getItem('gridscaper-darkmode') === '1') {
    body.classList.add('dark-mode');
    darkToggle.checked = true;
  }
  darkToggle?.addEventListener('change', e => {
    if (darkToggle.checked) {
      body.classList.add('dark-mode');
      localStorage.setItem('gridscaper-darkmode', '1');
    } else {
      body.classList.remove('dark-mode');
      localStorage.setItem('gridscaper-darkmode', '0');
    }
    // Optionally, update Three.js background for full effect
    if (window.THREE && window.scene) {
      window.scene.background = darkToggle.checked ? new window.THREE.Color('#0a1014') : new window.THREE.Color(0x87ceeb);
    }
    // Update 3D scene DOM label styles
    if (window.updateSceneLabelStylesForDarkMode) {
      window.updateSceneLabelStylesForDarkMode(darkToggle.checked);
    }
  });
</script>

<!-- Toast Notification Container -->
<div id="toastContainer"></div>

</body>
</html>
